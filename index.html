<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CollabTask - Pro Board</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- üé® RENK PALETƒ∞ --- */
        :root {
            --bg-body: #f8f9fa;
            --text-main: #212529;
            --card-bg-right: #ffffff;
            --card-bg-left: #d1e7dd;
            --input-bg: #ffffff;
            --input-text: #212529;
            --input-border: #0d6efd;
            --modal-bg: #ffffff;
            --modal-text: #000000;
            --placeholder-color: #6c757d;
        }

        /* DARK MODE */
        body.dark-mode {
            --bg-body: #121212;
            --text-main: #e0e0e0;
            --card-bg-right: #2c2c2c;
            --card-bg-left: #145c43;
            --input-bg: #2c2c2c;
            --input-text: #e0e0e0;
            --input-border: #555;
            --modal-bg: #2c2c2c;
            --modal-text: #ffffff;
            --placeholder-color: #adb5bd;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        body.dark-mode .text-muted { color: #adb5bd !important; }
        .form-control::placeholder { color: var(--placeholder-color) !important; opacity: 1; }

        /* --- üìä DASHBOARD --- */
        .stats-container {
            display: flex;
            justify-content: space-around;
            background-color: rgba(0,0,0,0.05);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .stat-box { text-align: center; flex: 1; position: relative; }

        .stat-box:not(:last-child)::after {
            content: ''; position: absolute; right: 0; top: 10%; height: 80%; width: 1px; background-color: rgba(0,0,0,0.1); 
        }

        .stat-number { font-size: 1.5rem; font-weight: 800; display: block; line-height: 1.2; transition: color 0.3s; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }

        /* DARK MODE DASHBOARD */
        body.dark-mode .stats-container { background-color: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        body.dark-mode .stat-box:not(:last-child)::after { background-color: rgba(255,255,255,0.2); }
        body.dark-mode .text-primary { color: #9ec5fe !important; }
        body.dark-mode .text-success { color: #a3cfbb !important; }
        body.dark-mode .text-danger  { color: #ea868f !important; }
        body.dark-mode .stat-label { color: #e0e0e0; opacity: 0.9; }

        /* --- üíé MODERN HEADER --- */
        .modern-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            position: relative; overflow: hidden; border: none;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        .modern-header::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none;
        }
        .app-title {
            font-weight: 800; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            background: linear-gradient(to right, #fff, #e0e7ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block;
        }
        .app-subtitle { font-weight: 300; letter-spacing: 0.5px; color: rgba(255, 255, 255, 0.8); font-size: 0.85rem; position: relative; }

        .theme-switch-wrapper { position: absolute; top: 50%; transform: translateY(-50%); right: 20px; z-index: 100; display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 30px; position: relative; width: 55px; }
        .theme-switch input { display: none; }
        .slider { background-color: rgba(255, 255, 255, 0.3); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; border: 2px solid #fff; }
        .slider:before { background-color: #fff; bottom: 3px; content: "‚òÄÔ∏è"; height: 20px; width: 20px; left: 4px; position: absolute; transition: .4s; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; line-height: 1; }
        input:checked + .slider { background-color: #66bb6a; border-color: #66bb6a; }
        input:checked + .slider:before { transform: translateX(24px); content: "üåô"; background-color: #fff; }

        /* --- STYLES --- */
        .task-card { border-left: 6px solid transparent !important; transition: all 0.3s; }
        .priority-Normal { border-left-color: #0d6efd !important; }
        .priority-Acil { border-left-color: #fd7e14 !important; }
        .priority-Kritik { border: 2px solid #dc3545 !important; border-left: 10px solid #dc3545 !important; }
        .task-done.priority-Kritik { border-color: transparent !important; border-left-color: #adb5bd !important; }

        .deadline-warning { font-size: 0.75rem; font-weight: bold; color: #dc3545; display: inline-flex; align-items: center; gap: 4px; animation: blink 1.5s infinite; }
        .deadline-normal { font-size: 0.75rem; color: #6c757d; }
        body.dark-mode .deadline-normal { color: #adb5bd; }
        .deadline-expired-badge { font-size: 0.75rem; font-weight: bold; color: #fff; background: #dc3545; padding: 2px 6px; border-radius: 4px; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .task-expired .task-text { text-decoration: line-through; color: #dc3545 !important; opacity: 0.8; }
        .task-expired { background: linear-gradient(to right, #f8d7da 50%, #fff5f5 50%) !important; border-color: #dc3545 !important; }
        body.dark-mode .task-expired { background: linear-gradient(to right, #4a181d 50%, #2c0b0e 50%) !important; }

        .task-card { background: linear-gradient(to right, var(--card-bg-left) 50%, var(--card-bg-right) 50%); background-size: 200% 100%; background-position: 100% 0; color: var(--text-main); }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
        .task-done { background-position: 0% 0 !important; color: #adb5bd; }
        .task-done .task-text { text-decoration: line-through; opacity: 0.7; }

        .form-control, .form-select { background-color: var(--input-bg); color: var(--input-text); border-color: var(--input-border); }
        .form-control:focus, .form-select:focus { background-color: var(--input-bg); color: var(--input-text); }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px) rotate(-2deg); } 40%, 80% { transform: translateX(5px) rotate(2deg); } }
        .shake-it { animation: shake 0.4s ease-in-out; border: 2px solid #ffc107 !important; }

        #big-trash-bin { position: fixed; bottom: -150px; left: 50%; transform: translateX(-50%); font-size: 100px; z-index: 1050; transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; pointer-events: none; }
        @media (max-width: 576px) { #big-trash-bin { font-size: 60px; } }
        .trash-bin-visible { bottom: 20px !important; opacity: 1 !important; }
        @keyframes suckIntoTrash { 0% { transform: scale(1) translateY(0); opacity: 1; } 100% { transform: scale(0.1) translateY(100vh); opacity: 0; } }
        .sucked-into-trash { animation: suckIntoTrash 0.7s forwards ease-in; pointer-events: none; z-index: 999; position: relative; }

        .owner-badge { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .date-badge { font-size: 0.7rem; color: #888; display: flex; align-items: center; gap: 3px; white-space: nowrap; }
        body.dark-mode .date-badge { color: #adb5bd; }
        .priority-badge { font-size: 0.7rem; font-weight: bold; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="big-trash-bin">üóëÔ∏è</div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered px-3">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">‚ö†Ô∏è G√∂rev Siliniyor</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <p class="fs-5" id="deleteModalText">...</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Vazge√ß</button>
                    <button type="button" class="btn btn-danger px-4 fw-bold" onclick="confirmDeleteAction()">EVET, Sƒ∞L üóëÔ∏è</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4 mb-5">
        <div class="card shadow-lg border-0" style="background-color: var(--modal-bg);">
            
            <div class="card-header modern-header text-center py-4">
                <div class="theme-switch-wrapper">
                    <label class="theme-switch" for="checkbox">
                        <input type="checkbox" id="checkbox" onchange="toggleTheme(this)">
                        <div class="slider round"></div>
                    </label>
                </div>
                <h2 class="mb-1 d-flex justify-content-center align-items-center gap-2">
                    <span style="font-size: 1.8rem;">üöÄ</span> 
                    <span class="app-title display-6" style="font-size: 1.8rem;">CollabTask Pro</span>
                </h2>
                <p class="mb-0 app-subtitle"><span style="opacity: 0.6;">‚Äî</span> Vizyonerlerin ƒ∞≈ü Takip Paneli <span style="opacity: 0.6;">‚Äî</span></p>
            </div>

            <div class="card-body p-3 p-md-4">
                
                <div class="stats-container shadow-sm">
                    <div class="stat-box">
                        <span class="stat-number text-primary" id="stat-pending">0</span>
                        <span class="stat-label">Bekleyen</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-number text-success" id="stat-completed">0</span>
                        <span class="stat-label">Biten</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-number text-danger" id="stat-delayed">0</span>
                        <span class="stat-label">Geciken</span>
                    </div>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-md-9">
                        <input type="text" id="searchInput" class="form-control form-control-sm shadow-sm" placeholder="üîç G√∂rev veya isim ara..." oninput="filterTasks()">
                    </div>
                    <div class="col-md-3">
                        <select id="filterStatus" class="form-select form-select-sm shadow-sm fw-bold" onchange="filterTasks()">
                            <option value="All">üìÇ Hepsi</option>
                            <option value="Todo">üìù Yapƒ±lacaklar</option>
                            <option value="Done">‚úÖ Bitenler</option>
                            <option value="Expired">üî• Gecikenler</option>
                        </select>
                    </div>
                </div>

                <div class="row g-2 mb-4 align-items-end">
                    <div class="col-6 col-md-2">
                        <label class="small text-muted mb-1 ps-1">Adƒ±n</label>
                        <input type="text" id="ownerName" class="form-control form-control-sm border-primary shadow-sm fw-bold" placeholder="Kimsin?">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="small text-muted mb-1 ps-1">Son Tarih üìÖ</label>
                        <input type="datetime-local" id="taskDueDate" class="form-control form-control-sm border-primary shadow-sm" style="font-size: 0.9rem;">
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="small text-muted mb-1 ps-1">√ñnem</label>
                        <select id="taskPriority" class="form-select form-select-sm border-primary shadow-sm fw-bold text-center">
                            <option value="Normal" selected>üîµ Normal</option>
                            <option value="Acil">üü† Acil</option>
                            <option value="Kritik">üî¥ KRƒ∞Tƒ∞K</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="small text-muted mb-1 ps-1">G√∂rev</label>
                        <input type="text" id="taskTitle" class="form-control form-control-sm border-primary shadow-sm" placeholder="Ne yapƒ±lacak?" onkeydown="if(event.key === 'Enter') addTask()">
                    </div>
                    <div class="col-6 col-md-2 d-grid">
                        <button class="btn btn-dark btn-sm shadow-sm fw-bold py-2" onclick="addTask()">EKLE üöÄ</button>
                    </div>
                </div>

                <div id="taskList" class="list-group gap-3"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const BASE_URL = "https://localhost:7000"; 
        
        const successSound = new Audio("https://www.myinstants.com/media/sounds/ding-sound-effect_2.mp3"); successSound.volume = 0.4;
        const undoSound = new Audio("https://www.myinstants.com/media/sounds/whoosh-transition.mp3"); undoSound.volume = 0.3;
        const trashSound = new Audio("https://www.myinstants.com/media/sounds/crumpling-paper-sound-effect.mp3"); trashSound.volume = 0.6;

        let idToDelete = null;
        let deleteModalInstance = null;
        
        let g_tasks = [];

        const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            document.body.classList.add(currentTheme + "-mode");
            if (currentTheme === 'dark') toggleSwitch.checked = true;
        }

        function toggleTheme(e) {
            if (e.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        }

        const connection = new signalR.HubConnectionBuilder()
            .withUrl(`${BASE_URL}/taskHub`)
            .build();

        connection.start().catch(err => console.error("Baƒülantƒ± Hatasƒ±:", err));

        // --- EVENTS ---
        connection.on("ReceiveTaskAdded", (task) => {
            g_tasks.push(task); 
            updateStats();  
            filterTasks(); // Yeni eklenen arama kriterine uyuyorsa g√∂ster
        });
        
        connection.on("ReceiveTaskDeleted", (id) => {
            g_tasks = g_tasks.filter(t => t.id !== id); 
            updateStats();
            filterTasks(); // Listeden silinince filtreyi yenile
            
            // Animasyon i√ßin DOM'dan bul (Eƒüer ekranda varsa)
            const taskEl = document.getElementById(`task-${id}`);
            const trashBin = document.getElementById("big-trash-bin");
            if (taskEl) {
                trashSound.currentTime = 0; trashSound.play().catch(()=>{});
                trashBin.classList.add("trash-bin-visible");
                taskEl.classList.add("sucked-into-trash");
                setTimeout(() => {
                    taskEl.remove();
                    trashBin.classList.remove("trash-bin-visible");
                }, 700); 
            }
        });

        connection.on("ReceiveTaskUpdated", (updatedTask) => {
            const index = g_tasks.findIndex(t => t.id === updatedTask.id);
            if(index !== -1) g_tasks[index] = updatedTask;
            updateStats();
            filterTasks(); // Durum deƒüi≈üince filtreyi g√ºncelle

            const oldCard = document.getElementById(`task-${updatedTask.id}`);
            if (oldCard) {
                // Sadece animasyon i√ßin eski karta efekt ver (Filtreleme kartƒ± yeniden olu≈üturacaƒüƒ± i√ßin bu kƒ±sƒ±m opsiyonel ama ge√ßi≈ü i√ßin iyi)
                if (updatedTask.status === "Done") {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    successSound.currentTime = 0; successSound.play().catch(()=>{});
                } else {
                    undoSound.currentTime = 0; undoSound.play().catch(()=>{});
                }
            }
        });

        // --- üîç Fƒ∞LTRELEME MANTIƒûI (YENƒ∞) ---
        function filterTasks() {
            const searchText = document.getElementById("searchInput").value.toLowerCase();
            const filterVal = document.getElementById("filterStatus").value;
            const list = document.getElementById("taskList");
            list.innerHTML = ""; // Listeyi temizle

            const now = new Date();

            const filtered = g_tasks.filter(task => {
                // 1. Metin Aramasƒ±
                const inTitle = task.title.toLowerCase().includes(searchText);
                const inOwner = task.owner ? task.owner.toLowerCase().includes(searchText) : false;
                const textMatch = inTitle || inOwner;

                // 2. Durum Filtresi
                let statusMatch = true;
                let isExpired = false;
                if(task.dueDate) {
                    if((new Date(task.dueDate) - now) < 0) isExpired = true;
                }

                if (filterVal === "Todo") statusMatch = task.status !== "Done";
                if (filterVal === "Done") statusMatch = task.status === "Done";
                if (filterVal === "Expired") statusMatch = (task.status !== "Done" && isExpired);

                return textMatch && statusMatch;
            });

            // Filtrelenenleri ekrana bas (Ters sƒ±rada)
            // g_tasks normalde eskiden yeniye gelir, biz yeni en √ºstte olsun istiyoruz.
            // Bu y√ºzden forEach ile afterbegin yapƒ±yoruz.
            filtered.forEach(appendTaskToScreen);
        }

        function updateStats() {
            let pending = 0;
            let completed = 0;
            let delayed = 0;
            const now = new Date();

            g_tasks.forEach(task => {
                if (task.status === "Done") {
                    completed++;
                } else {
                    pending++;
                    if (task.dueDate) {
                        const due = new Date(task.dueDate);
                        if (due < now) delayed++;
                    }
                }
            });

            document.getElementById("stat-pending").innerText = pending;
            document.getElementById("stat-completed").innerText = completed;
            document.getElementById("stat-delayed").innerText = delayed;
        }

        function getDeadlineHtml(dueDateString) {
            if (!dueDateString) return "";
            const due = new Date(dueDateString);
            const now = new Date();
            const diffMs = due - now;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const dateStr = due.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }) + " " + due.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

            if (diffMs < 0) return `<span class="deadline-expired-badge">‚ö†Ô∏è Deadline Ge√ßti! (${dateStr})</span>`;
            if (diffHrs < 24) {
                let timeText = diffHrs > 0 ? `${diffHrs} Saat` : `${Math.floor(diffMs / (1000 * 60))} Dk`;
                return `<span class="deadline-warning">üî• Dƒ∞KKAT! ${timeText} Kaldƒ±</span>`;
            }
            return `<span class="deadline-normal">üìÖ Son: ${dateStr}</span>`;
        }

        function formatDate(dateString) {
            if(!dateString) return "";
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }) + " ‚Ä¢ " + date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        }

        function appendTaskToScreen(task) {
            const list = document.getElementById("taskList");
            const isDone = task.status === "Done";
            
            let isExpired = false;
            let deadlineHtml = "";
            if (task.dueDate) {
                const due = new Date(task.dueDate);
                if ((due - new Date()) < 0) isExpired = true;
                deadlineHtml = getDeadlineHtml(task.dueDate);
            }

            const doneClass = isDone ? "task-done" : "";
            const expiredClass = (!isDone && isExpired) ? "task-expired" : ""; 
            const btnText = isDone ? "‚Ü©Ô∏è" : "‚úÖ";
            const btnClass = isDone ? "btn-secondary" : "btn-success";
            const ownerName = task.owner ? task.owner : "Anonim";
            const safeTitle = task.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const formattedDate = formatDate(task.createdAt);
            
            const priority = task.priority || "Normal";
            const priorityClass = `priority-${priority}`;
            let priorityIcon = "";
            if(priority === "Acil") priorityIcon = "üü†";
            if(priority === "Kritik") priorityIcon = "üî¥";

            let btnDisabled = "";
            let btnTitle = "";
            if (!isDone && isExpired) {
                btnDisabled = "disabled";
                btnTitle = "S√ºresi dolduƒüu i√ßin tamamlanamaz!";
            }

            const item = `
                <div id="task-${task.id}" class="list-group-item task-card shadow shadow-sm rounded-4 border-0 p-3 ${doneClass} ${priorityClass} ${expiredClass}">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center w-100 gap-2">
                        <div class="d-flex flex-column align-items-start w-100">
                            <div class="d-flex align-items-center flex-wrap gap-2 mb-1">
                                <span class="badge bg-info text-dark owner-badge shadow-sm">üë§ ${ownerName}</span>
                                <span class="date-badge">üïí ${formattedDate}</span>
                                <span class="priority-badge">${priorityIcon}</span>
                                <div class="ms-2">${deadlineHtml}</div>
                            </div>
                            <span class="fs-5 fw-semibold task-text ms-1 text-break w-100">${task.title}</span>
                        </div>
                        <div class="btn-group shadow-sm ms-auto ms-md-0" style="min-width: 120px;">
                            <button class="btn ${btnClass} btn-sm btn-check-task fw-bold px-3" onclick="toggleTask(${task.id})" ${btnDisabled} title="${btnTitle}">${btnText}</button>
                            <button class="btn btn-danger btn-sm px-3" onclick="askToDelete(${task.id}, '${safeTitle}')">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            list.insertAdjacentHTML("afterbegin", item);
        }

        async function loadTasks() {
            try {
                const res = await fetch(`${BASE_URL}/api/tasks`);
                const tasks = await res.json();
                g_tasks = tasks; 
                updateStats();   
                filterTasks(); // ƒ∞lk y√ºklemede filtreyi √ßalƒ±≈ütƒ±r
            } catch (error) { console.error("API Hatasƒ±:", error); }
        }

        async function addTask() {
            const titleInput = document.getElementById("taskTitle");
            const ownerInput = document.getElementById("ownerName");
            const priorityInput = document.getElementById("taskPriority");
            const dateInput = document.getElementById("taskDueDate");

            if(!titleInput.value) return;
            if(!ownerInput.value) { alert("Adƒ±nƒ± yazmayƒ± unuttun kral!"); return; }

            let dueDateVal = dateInput.value ? dateInput.value : null;

            await fetch(`${BASE_URL}/api/tasks`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    title: titleInput.value, 
                    owner: ownerInput.value, 
                    status: "Todo",
                    priority: priorityInput.value,
                    dueDate: dueDateVal
                })
            });
            titleInput.value = ""; 
        }

        function askToDelete(id, title) {
            idToDelete = id;
            document.getElementById("deleteModalText").innerHTML = `<strong>"${title}"</strong><br> To-Do'sunu silmek istediƒüinize emin misiniz?`;
            deleteModalInstance = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModalInstance.show();
        }

        async function confirmDeleteAction() {
            if (idToDelete) {
                await fetch(`${BASE_URL}/api/tasks/${idToDelete}`, { method: "DELETE" });
                if(deleteModalInstance) deleteModalInstance.hide();
                idToDelete = null;
            }
        }

        async function toggleTask(id) {
            await fetch(`${BASE_URL}/api/tasks/${id}`, { method: "PUT" });
        }

        loadTasks();
    </script>
</body>
</html>